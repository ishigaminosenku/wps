name: Build WPS Office 365 Edu (ID/EN)

on:
  workflow_dispatch:

jobs:
  build-wps:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget dpkg-dev

    - name: Download WPS Office 365 Edu Source
      run: |
        # URL for WPS Office 365 Education Edition
        WPS_URL="https://pubwps-wps365-obs.wpscdn.cn/download/Linux/365edu/12.1.2.23578/wps-office_12.1.2.23578.AK.preload.sw.withsn_amd64.deb"
        
        echo "Downloading WPS Office from $WPS_URL..."
        wget -q -O wps-original.deb "$WPS_URL"

    - name: Extract Deb Package
      run: |
        # CORRECTION: Only create the root build folder. 
        # Do NOT create build/DEBIAN manually; dpkg-deb does this automatically.
        mkdir -p build
        
        # Extract files and control info
        dpkg-deb -R wps-original.deb build/

    - name: Configure Language to English
      run: |
        echo "Patching language configuration..."
        
        # 1. Modify the default MUI config
        MUI_PATH="build/opt/kingsoft/wps-office/office6/mui"
        
        if [ -f "$MUI_PATH/languages" ]; then
            sed -i 's/zh_CN/en_US/g' "$MUI_PATH/languages"
        fi

        # 2. Inject global variable script for Indonesian/English locale
        mkdir -p build/etc/profile.d/
        
        # Create a startup script that forces English UI
        # This overrides the Chinese default often found in the Education edition
        cat <<EOF > build/etc/profile.d/wps-365.sh
        export MALLOC_CHECK_=0
        export LANGUAGE=en_US:en
        export LANG=en_US.UTF-8
        export LC_ALL=en_US.UTF-8
        EOF
        
        chmod +x build/etc/profile.d/wps-365.sh

    - name: Update Package Metadata
      run: |
        CONTROL_FILE="build/DEBIAN/control"
        
        # Rename package to distinguish it
        sed -i 's/Package: wps-office/Package: wps-office-365-edu-id/g' "$CONTROL_FILE"
        
        # Update Maintainer info
        sed -i 's/Maintainer: .*/Maintainer: Custom Build <github-actions@local>/g' "$CONTROL_FILE"

    - name: Build New Deb Package
      run: |
        # Repackage the build directory
        dpkg-deb -b build wps-office-365-edu-id_amd64.deb

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: wps-office-365-edu-id
        path: wps-office-365-edu-id_amd64.deb
        retention-days: 5
